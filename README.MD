# Federated Anomaly Detection with WADI Dataset

## ğŸ“‹ ì‹¤í—˜ ê°œìš”

ë³¸ ë ˆí¬ëŠ” **ê³„ì¸µì  ì—°í•©í•™ìŠµì´ WADIì²˜ëŸ¼ ë¶ˆê· í˜•Â·ë¶„í¬ê°€ ìš”ë™ì¹˜ëŠ” ì‹œê³„ì—´ì—ì„œë„ ì‹¤ì œë¡œ ë„ì›€ì´ ë˜ëŠ”ê°€**ë¼ëŠ” í•µì‹¬ ì§ˆë¬¸ì— ë‹µí•˜ê¸° ìœ„í•œ ì‹¤í—˜ì…ë‹ˆë‹¤.

### ğŸ¯ ì‹¤í—˜ ëª©í‘œ

1. **ì§‘ê³„ ì•Œê³ ë¦¬ì¦˜ íš¨ê³¼ ê²€ì¦**: FedAvg, FedProx, FedAdamì˜ ì„±ëŠ¥ ë¹„êµ
2. **í†µì‹  íš¨ìœ¨ì„± ê²€ì¦**: Frozen Encoder ì „ëµì˜ í†µì‹ ëŸ‰ ì ˆì•½ íš¨ê³¼
3. **ë¶„í¬ ë³€ë™ ëŒ€ì‘ë ¥ ê²€ì¦**: Wasserstein Distance ê¸°ë°˜ ë¶„í¬ ë³€í™” ê°ì§€ ë° ëŒ€ì‘

### ğŸ—ï¸ ì‹¤í—˜ ì„¤ê³„

#### ë°ì´í„° ë¶„í•  ì „ëµ
```
WADI ë°ì´í„° â†’ 3ê°œ Edge ë¶„ë¦¬:
- Edge 0: ìœ ëŸ‰/ì••ë ¥ ê³µê²© ì§‘ì¤‘ + ì •ìƒ ë°ì´í„° 1/3
- Edge 1: ì„¼ì„œ/ì€ë‹‰ ê³µê²© ì§‘ì¤‘ + ì •ìƒ ë°ì´í„° 1/3  
- Edge 2: í’ˆì§ˆ/ìˆ˜ì•• ê³µê²© ì§‘ì¤‘ + ì •ìƒ ë°ì´í„° 1/3
```

#### ëª¨ë¸ ì•„í‚¤í…ì²˜
- **Anomaly Transformer**: ì‹œê³„ì—´ ì´ìƒ íƒì§€ì— íŠ¹í™”ëœ Transformer ê¸°ë°˜ ëª¨ë¸
- **ì…ë ¥ ì°¨ì›**: 123ê°œ WADI ì„¼ì„œ í”¼ì²˜
- **ì‹œí€€ìŠ¤ ê¸¸ì´**: 60 ì‹œì 
- **ì¶œë ¥**: ì •ìƒ(0) vs ì´ìƒ(1) ì´ì§„ ë¶„ë¥˜

#### ì‹¤í—˜ ì¡°í•© (ì´ 18ê°€ì§€)
```
ì§‘ê³„ ì•Œê³ ë¦¬ì¦˜ (3ê°œ) Ã— Encoder ì „ëµ (2ê°œ) Ã— Edge ìˆ˜ (3ê°œ ê³ ì •)
- FedAvg, FedProx, FedAdam
- Frozen Encoder vs Full Fine-tuning
- 3ê°œ Edge ê³ ì •
```

#### ë¶„í¬ ë³€ë™ ì‹œë‚˜ë¦¬ì˜¤
- **ë¼ìš´ë“œ 50**ì—ì„œ Edge 2ì— ê¸‰ê²©í•œ ë¶„í¬ ë³€í™” ì ìš©
- **ìŠ¤ì¼€ì¼ 2ë°° ì¦ê°€**ë¡œ ê³µê²© íŒ¨í„´ ë³€í™” ì‹œë®¬ë ˆì´ì…˜
- **Wasserstein Distance > 0.2**ì‹œ ì¬ë°°ì¹˜ íŠ¸ë¦¬ê±°

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### í™˜ê²½ ì„¤ì •

```bash
# 1. ê°€ìƒí™˜ê²½ ìƒì„± (ê¶Œì¥)
python -m venv venv
venv\Scripts\activate  # Windows
# source venv/bin/activate  # Linux/Mac

# 2. ì˜ì¡´ì„± ì„¤ì¹˜
pip install -r requirements.txt

# 3. ë°ì´í„° í™•ì¸
# WADI_FINAL_DATASET.csv íŒŒì¼ì´ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸
```

### ë‹¨ì¼ ì‹¤í—˜ ì‹¤í–‰

```bash
# FedAvg + Full Modelë¡œ 100 ë¼ìš´ë“œ ì‹¤í—˜
python experiment_runner.py --algorithm fedavg --encoder full --rounds 100

# FedProx + Frozen Encoderë¡œ 50 ë¼ìš´ë“œ ì‹¤í—˜  
python experiment_runner.py --algorithm fedprox --encoder frozen --rounds 50

# FedAdam + Full Modelë¡œ ì‹¤í—˜
python experiment_runner.py --algorithm fedadam --encoder full --rounds 100
```

### ì „ì²´ ì‹¤í—˜ ì‹¤í–‰ (ê¶Œì¥)

```bash
# ëª¨ë“  ì¡°í•© ì‹¤í—˜ (ì´ 6ê°œ: 3 ì•Œê³ ë¦¬ì¦˜ Ã— 2 Encoder ì „ëµ)
python experiment_runner.py --algorithm all --encoder both --rounds 100

# íŠ¹ì • ì•Œê³ ë¦¬ì¦˜ ëª¨ë“  Encoder ì „ëµ
python experiment_runner.py --algorithm fedprox --encoder both --rounds 100
```

### ê²°ê³¼ ë¶„ì„ë§Œ ì‹¤í–‰

```bash
# ê¸°ì¡´ ì‹¤í—˜ ê²°ê³¼ ë¶„ì„ ë° ì‹œê°í™”
python experiment_runner.py --analyze_only
```

## ğŸ“Š ì‹¤í—˜ ê²°ê³¼ ì´í•´

### ì¶œë ¥ íŒŒì¼ êµ¬ì¡°

```
results/
â”œâ”€â”€ fedavg_full_YYYYMMDD_HHMMSS_history.csv     # ì‹¤í—˜ë³„ ìƒì„¸ ë¡œê·¸
â”œâ”€â”€ fedprox_frozen_YYYYMMDD_HHMMSS_history.csv  # ë¼ìš´ë“œë³„ ë©”íŠ¸ë¦­
â”œâ”€â”€ all_experiments_YYYYMMDD_HHMMSS.json        # ì „ì²´ ì‹¤í—˜ ê²°ê³¼
â”œâ”€â”€ experiment_results.png                      # ì‹œê°í™” ì°¨íŠ¸
â””â”€â”€ experiment_report.md                        # ìš”ì•½ ë³´ê³ ì„œ
```

### ì£¼ìš” ë©”íŠ¸ë¦­

1. **ì„±ëŠ¥ ë©”íŠ¸ë¦­**
   - `val_f1_avg`: ê²€ì¦ F1 ì ìˆ˜ (ì£¼ìš” ì§€í‘œ)
   - `val_accuracy_avg`: ê²€ì¦ ì •í™•ë„
   - `val_loss_avg`: ê²€ì¦ ì†ì‹¤

2. **í†µì‹  ë©”íŠ¸ë¦­**
   - Frozen Encoder: ~50% í†µì‹ ëŸ‰ ê°ì†Œ ì˜ˆìƒ
   - íŒŒë¼ë¯¸í„° ìˆ˜: Detection Headë§Œ ì „ì†¡

3. **ë¶„í¬ ë³€ë™ ë©”íŠ¸ë¦­**
   - `wasserstein_distance`: ë¶„í¬ ë³€í™” ì •ë„
   - `shift_detected`: ì„ê³„ê°’(0.2) ì´ˆê³¼ ì—¬ë¶€
   - `rounds_to_recover`: F1 ì ìˆ˜ íšŒë³µê¹Œì§€ ë¼ìš´ë“œ ìˆ˜

## ğŸ” ì„¸ë¶€ êµ¬í˜„ ì„¤ëª…

### í•µì‹¬ ì»´í¬ë„ŒíŠ¸

#### 1. ë°ì´í„° ë¡œë” (`data_loader.py`)
```python
# WADI ë°ì´í„°ë¥¼ ì—°í•©í•™ìŠµìš©ìœ¼ë¡œ ë¶„í• 
loader = WADIDataLoader("WADI_FINAL_DATASET.csv")
X, y = loader.load_and_preprocess()
data_splits = loader.create_federated_split(X, y)
```

#### 2. Anomaly Transformer (`anomaly_transformer.py`)
```python
# Transformer ê¸°ë°˜ ì´ìƒ íƒì§€ ëª¨ë¸
model = create_model(input_dim=123, frozen_encoder=True)
model.freeze_encoder()  # Frozen Encoder ì „ëµ
```

#### 3. ì§‘ê³„ ì•Œê³ ë¦¬ì¦˜ (`fl_algorithms.py`)
```python
# ì„¸ ê°€ì§€ ì§‘ê³„ ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
aggregator = create_aggregator('fedprox', device, mu=0.01)
global_weights = aggregator.aggregate(client_weights, client_samples)
```

#### 4. Flower í†µí•© (`fl_client.py`, `fl_server.py`)
```python
# í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ëŠ” Flower í”„ë ˆì„ì›Œí¬ ê¸°ë°˜
client = create_client(client_id, model, trainloader, valloader, device, config)
server = create_strategy(model, algorithm, config)
```

### ì‹¤í—˜ íë¦„

1. **ì‚¬ì „í•™ìŠµ** (Frozen Encoder ì‚¬ìš©ì‹œ)
   ```python
   # ì •ìƒ ë°ì´í„°ë¡œ Encoder ì‚¬ì „í•™ìŠµ
   pretrain_encoder(model, pretrain_dataloader, device, epochs=10)
   ```

2. **ì—°í•©í•™ìŠµ ë¼ìš´ë“œ**
   ```python
   for round in range(100):
       # í´ë¼ì´ì–¸íŠ¸ í›ˆë ¨
       client_weights = train_clients(global_weights)
       
       # ì§‘ê³„
       global_weights = aggregator.aggregate(client_weights, samples)
       
       # ë¶„í¬ ë³€ë™ ê°ì§€ (ë¼ìš´ë“œ 50)
       if round == 50:
           apply_distribution_shift(client_2)
   ```

3. **ê²°ê³¼ ìˆ˜ì§‘**
   ```python
   # CSVë¡œ ë¼ìš´ë“œë³„ ë©”íŠ¸ë¦­ ì €ì¥  
   metrics = evaluate_global_model(global_weights)
   save_to_csv(round, metrics)
   ```

## ğŸ“ˆ ì˜ˆìƒ ê²°ê³¼

### ì„±ëŠ¥ ë¹„êµ
- **FedAdam**: ê°€ì¥ ë†’ì€ F1 ì ìˆ˜ ì˜ˆìƒ (ì ì‘ì  í•™ìŠµë¥ )
- **FedProx**: ë¶ˆê· í˜• ë°ì´í„°ì—ì„œ ì•ˆì •ì  ìˆ˜ë ´
- **FedAvg**: ê¸°ì¤€ì„  ì„±ëŠ¥

### í†µì‹  íš¨ìœ¨ì„±
- **Frozen Encoder**: ~50% í†µì‹ ëŸ‰ ê°ì†Œ, ì„±ëŠ¥ í•˜ë½ <1%
- **Full Model**: ê¸°ì¤€ í†µì‹ ëŸ‰, ìµœëŒ€ ì„±ëŠ¥

### ë¶„í¬ ë³€ë™ ëŒ€ì‘
- **Wasserstein Distance > 0.2**: ìë™ ì¬ë°°ì¹˜ íŠ¸ë¦¬ê±°
- **F1 íšŒë³µ ì†ë„**: ì¬ë°°ì¹˜ ì ìš©ì‹œ 2-3ë°° ë¹ ë¥¸ íšŒë³µ

## ğŸ”§ ì»¤ìŠ¤í…€ ì‚¬ìš©ë²•

### ì»¤ìŠ¤í…€ ëª¨ë¸ ì„¤ì •

```python
# anomaly_transformer.py ìˆ˜ì •
model_config = {
    'd_model': 512,        # ëª¨ë¸ ì°¨ì› ì¦ê°€
    'n_heads': 16,         # ì–´í…ì…˜ í—¤ë“œ ìˆ˜ ì¦ê°€  
    'n_layers': 8,         # ë ˆì´ì–´ ìˆ˜ ì¦ê°€
    'd_ff': 2048,          # Feed-forward ì°¨ì›
    'dropout': 0.2         # ë“œë¡­ì•„ì›ƒ ë¹„ìœ¨
}
```

### ì»¤ìŠ¤í…€ ì§‘ê³„ ì•Œê³ ë¦¬ì¦˜ íŒŒë¼ë¯¸í„°

```python
# FedProx proximal parameter ì¡°ì •
python experiment_runner.py --algorithm fedprox --mu 0.05

# FedAdam í•™ìŠµë¥  ì¡°ì •  
python experiment_runner.py --algorithm fedadam --eta 0.001
```

### ë¶„í¬ ë³€ë™ ì‹œë‚˜ë¦¬ì˜¤ ì»¤ìŠ¤í„°ë§ˆì´ì§•

```python
# fl_server.pyì˜ configure_fit ë©”ì†Œë“œ ìˆ˜ì •
if server_round == 30:  # ë¼ìš´ë“œ 30ì—ì„œ ë³€í™”
    config['shift_intensity'] = 3.0  # ê°•ë„ 3ë°°
```

## ğŸ› ë¬¸ì œ í•´ê²°


1. **CUDA ë©”ëª¨ë¦¬ ë¶€ì¡±**
   ```bash
   # ë°°ì¹˜ í¬ê¸° ê°ì†Œ
   # data_loader.pyì—ì„œ batch_size=16ìœ¼ë¡œ ìˆ˜ì •
   ```

2. **Flower ì—°ê²° ì˜¤ë¥˜**
   ```bash
   # í¬íŠ¸ ì¶©ëŒì‹œ í¬íŠ¸ ë³€ê²½
   python experiment_runner.py --server_address 0.0.0.0:8081
   ```

3. **ë°ì´í„° ë¡œë”© ì˜¤ë¥˜**
   ```bash
   # WADI_FINAL_DATASET.csv ê²½ë¡œ í™•ì¸
   python experiment_runner.py --data_path /path/to/WADI_FINAL_DATASET.csv
   ```


## ğŸ“š ì°¸ê³  ë¬¸í—Œ

1. **Anomaly Transformer**: "Anomaly Transformer: Time Series Anomaly Detection with Association Discrepancy"
2. **FedAvg**: "Communication-Efficient Learning of Deep Networks from Decentralized Data"
3. **FedProx**: "Federated Optimization in Heterogeneous Networks"
4. **FedAdam**: "Adaptive Federated Optimization"
5. **WADI Dataset**: "A Multi-stage Cyber Attack Dataset"


---

## âš¡ ì‹¤í—˜ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Python 3.8+ ì„¤ì¹˜ í™•ì¸
- [ ] ê°€ìƒí™˜ê²½ ìƒì„± ë° í™œì„±í™”
- [ ] `pip install -r requirements.txt` ì‹¤í–‰
- [ ] `WADI_FINAL_DATASET.csv` íŒŒì¼ í™•ì¸
- [ ] `python experiment_runner.py --algorithm all --encoder both --rounds 100` ì‹¤í–‰
- [ ] `results/` í´ë”ì—ì„œ ê²°ê³¼ í™•ì¸
- [ ] `experiment_report.md`ì—ì„œ ìš”ì•½ ê²°ê³¼ í™•ì¸
